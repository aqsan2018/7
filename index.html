<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Kiss Filler</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’‹</text></svg>">
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
  overscroll-behavior: none;
}
body {
  background: #fce7f3;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  overflow: hidden;
  touch-action: none;
}
#container {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}
#instructions {
  position: absolute;
  top: 35%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2rem;
  color: #db2777;
  text-align: center;
  font-weight: 700;
  z-index: 400;
  pointer-events: none;
  user-select: none;
}
#final-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 600;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.4s ease;
  background: rgba(255, 255, 255, 0.65);
  padding: clamp(1rem, 3vw, 2rem);
  border-radius: 1rem;
  backdrop-filter: blur(6px);
  display: flex;
  flex-direction: column;
  align-items: center;
  width: min(90vw, 600px);
  max-height: 70vh;
  overflow-y: auto;
  box-sizing: border-box;
}
#message-text {
  font-size: clamp(1rem, 2vw + 0.5rem, 1.5rem);
  color: #be185d;
  text-align: center;
  font-weight: 600;
  user-select: none;
  margin-bottom: 1.5rem;
  line-height: 1.5;
  word-break: break-word;
  white-space: pre-wrap;
}
#play-again-button {
  pointer-events: all;
  background-color: #db2777;
  color: white;
  font-size: 1.1rem;
  font-weight: 700;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#play-again-button:hover { background-color: #be185d; }
#click-counter {
  position: absolute;
  top: 18px;
  left: 18px;
  font-size: 1.2rem;
  color: #9d174d;
  z-index: 400;
  user-select: none;
}
canvas {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
  pointer-events: none;
}

/* Password overlay */
#password-overlay {
  position: fixed;
  inset: 0;
  background: rgba(251, 207, 232, 0.8);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  transition: opacity 0.5s ease;
}
#lock-box {
  background-color: white;
  padding: 2rem 2.5rem;
  border-radius: 1rem;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: fadeIn 0.8s ease;
}
#lock-gif {
  width: 100px;
  height: 100px;
  margin-bottom: 1rem;
  animation: pulse 1.5s infinite alternate;
}
#password-input {
  font-size: 1.1rem;
  padding: 0.6rem 1rem;
  border: 2px solid #f472b6;
  border-radius: 8px;
  outline: none;
  text-align: center;
  margin-bottom: 1rem;
}
#password-input:focus { border-color: #db2777; }
#submit-button {
  background: #db2777;
  color: white;
  border: none;
  font-size: 1rem;
  font-weight: 600;
  padding: 0.6rem 1.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}
#submit-button:hover { background: #be185d; }
#error-message {
  color: #be185d;
  font-size: 0.9rem;
  height: 1rem;
  margin-top: 0.5rem;
}
@keyframes shake {
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}
@keyframes fadeIn {
  from {opacity:0; transform:scale(0.95);}
  to {opacity:1; transform:scale(1);}
}
@keyframes pulse {
  from {transform:scale(1);}
  to {transform:scale(1.08);}
}
</style>
</head>

<body>
<div id="password-overlay">
  <form id="lock-box">
    <img id="lock-gif" src="dudu-no-dudu.gif" alt="Lock GIF">
    <input id="password-input" type="password" placeholder="Enter password">
    <p id="error-message"></p>
    <button id="submit-button" type="submit">Unlock</button>
  </form>
</div>

<div id="container">
  <div id="instructions">I'm feeling a little un-loved.<br>Click to fill me up!</div>
  <div id="final-message">
    <p id="message-text"></p>
    <button id="play-again-button">Again</button>
  </div>
  <div id="click-counter">Kisses: 0</div>
</div>

<audio id="reveal-sound" src="reveal_ding.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const { Engine, Render, Runner, World, Bodies, Events, Composite } = Matter;
  const container = document.getElementById('container');
  const instructions = document.getElementById('instructions');
  const finalMessage = document.getElementById('final-message');
  const messageText = document.getElementById('message-text');
  const playAgainButton = document.getElementById('play-again-button');
  const clickCounter = document.getElementById('click-counter');
  const revealSound = document.getElementById('reveal-sound');

  const overlay = document.getElementById('password-overlay');
  const lockBox = document.getElementById('lock-box');
  const passInput = document.getElementById('password-input');
  const errorMsg = document.getElementById('error-message');
  const correctPassword = "28072018";

  const STORAGE_PREFIX = 'kiss_seq_';
  let ownerKey = null;

  function hashString(s){
    let h=5381;
    for(let i=0;i<s.length;i++) h=((h<<5)+h)+s.charCodeAt(i);
    return String(h>>>0);
  }

  function initOwnerKey(){
    return fetch('https://api.ipify.org?format=json')
      .then(r=>r.json()).then(d=>{
        const ip=d?.ip||'local';
        ownerKey=STORAGE_PREFIX+hashString(ip);
      }).catch(()=>{ownerKey=STORAGE_PREFIX+'local';});
  }

  function loadIndex(){try{return parseInt(localStorage.getItem(ownerKey+'_i'))||0;}catch{return 0;}}
  function saveIndex(i){try{localStorage.setItem(ownerKey+'_i',String(i));}catch{}}

  const messages = [
    "1. You know what I adore most about you?\nThe way your laugh feels like home.\nThe way your eyes calm my chaos.\nYou donâ€™t even try, and yet you mean everything.",
    "2. Sometimes I stop and just smile â€”\nbecause somehow you exist.\nYouâ€™re like a quiet miracle I get to know.\nAnd I never get used to that feeling.",
    "3. I swear, your presence is like soft sunlight.\nNot blinding, just warm enough to make the world okay again.\nHow do you do that so effortlessly?",
    "4. Every kiss feels like a small promise.\nA quiet way of saying, 'Iâ€™m here. Iâ€™m not going anywhere.'\nAnd that means more than you realize.",
    "5. You have this calm magic about you.\nEven when the world feels heavy,\nyou make it lighter â€” just by being near."
  ];

  function getNextMessage(){
    let i=loadIndex();
    const msg=messages[i];
    i=(i+1)%messages.length;
    saveIndex(i);
    return msg;
  }

  lockBox.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(passInput.value===correctPassword){
      overlay.style.opacity='0';
      setTimeout(()=>overlay.style.display='none',500);
      await initOwnerKey();
      initGame();
    } else {
      errorMsg.textContent="Wrong password!";
      lockBox.style.animation='shake 0.4s';
      setTimeout(()=>lockBox.style.animation='',400);
    }
  });

  function initGame(){
    let worldWidth = document.documentElement.clientWidth;
    let worldHeight = document.documentElement.clientHeight;
    const emojiPx = 56, physicsRadius = emojiPx/2, clicksToReveal = 50;
    const emojiList = ['ðŸ’‹','â¤ï¸','ðŸ˜˜'];

    const engine = Engine.create({gravity:{y:0.45}});
    const world = engine.world;
    const render = Render.create({
      element: container,
      engine,
      options: {
        width: worldWidth,
        height: worldHeight,
        wireframes: false,
        background: 'transparent'
      }
    });
    Render.run(render);
    Runner.run(Runner.create(), engine);

    const wallOpts = {isStatic:true, render:{visible:false}};
    World.add(world,[
      Bodies.rectangle(worldWidth/2,worldHeight+40,worldWidth+200,80,wallOpts),
      Bodies.rectangle(-40,worldHeight/2,80,worldHeight,wallOpts),
      Bodies.rectangle(worldWidth+40,worldHeight/2,80,worldHeight,wallOpts)
    ]);

    const imageCache=new Map(), bodyEmoji=new Map();
    function emojiToCodePoint(e){return Array.from(e).map(c=>c.codePointAt(0).toString(16)).join('-');}
    function loadEmojiPNG(e){
      if(imageCache.has(e))return;
      const code=emojiToCodePoint(e);
      const url=`https://twemoji.maxcdn.com/v/latest/72x72/${code}.png`;
      const img=new Image(); img.crossOrigin='anonymous';
      img.onload=()=>imageCache.set(e,img);
      img.onerror=()=>imageCache.set(e,null);
      img.src=url;
    }
    emojiList.forEach(loadEmojiPNG);

    Events.on(render,'afterRender',()=>{
      const ctx=render.context;
      bodyEmoji.forEach((emoji,id)=>{
        const b=world.bodies.find(bb=>bb.id===id);
        if(!b)return;
        ctx.save(); ctx.translate(b.position.x,b.position.y); ctx.rotate(b.angle);
        const img=imageCache.get(emoji);
        if(img){ctx.drawImage(img,-emojiPx/2,-emojiPx/2,emojiPx,emojiPx);}
        else{
          ctx.font=`${emojiPx}px "Segoe UI Emoji","Apple Color Emoji",sans-serif`;
          ctx.textAlign='center';
          ctx.textBaseline='middle';
          ctx.fillText(emoji,0,0);
        }
        ctx.restore();
      });
    });

    const kissSounds=[new Audio('kiss1.mp3'),new Audio('kiss2.mp3')];
    kissSounds.forEach(s=>{s.preload='auto'; s.load();});
    let kissIndex=0, clickCount=0, messageRevealed=false;

    function addEmoji(x,y){
      if(messageRevealed)return;
      clickCount++;
      clickCounter.textContent=`Kisses: ${clickCount}`;
      const sound=kissSounds[kissIndex];
      try{sound.pause(); sound.currentTime=0; sound.play().catch(()=>{});}catch{}
      kissIndex=(kissIndex+1)%kissSounds.length;

      const emoji=emojiList[Math.floor(Math.random()*emojiList.length)];
      const body=Bodies.circle(x,y,physicsRadius,{restitution:0.6,friction:0.2,density:0.005});
      World.add(world,body);
      bodyEmoji.set(body.id,emoji);

      if(clickCount===1) instructions.style.opacity='0';
      if(clickCount>=clicksToReveal && !messageRevealed){
        messageRevealed=true;
        const msg=getNextMessage();
        messageText.textContent=msg;
        finalMessage.style.opacity='1';
        revealSound.currentTime=0; revealSound.play().catch(()=>{});
      }
    }

    function resetGame(){
      finalMessage.style.opacity='0';
      Composite.clear(world,false);
      bodyEmoji.clear();
      World.add(world,[
        Bodies.rectangle(worldWidth/2,worldHeight+40,worldWidth+200,80,wallOpts),
        Bodies.rectangle(-40,worldHeight/2,80,worldHeight,wallOpts),
        Bodies.rectangle(worldWidth+40,worldHeight/2,80,worldHeight,wallOpts)
      ]);
      clickCount=0; messageRevealed=false;
      clickCounter.textContent='Kisses: 0';
    }

    container.addEventListener('click', e => {
      const r=container.getBoundingClientRect();
      addEmoji(e.clientX-r.left,e.clientY-r.top);
    });

    playAgainButton.addEventListener('click', resetGame);

    // keep canvas size consistent on resize
    window.addEventListener('resize', ()=>{
      render.canvas.width = document.documentElement.clientWidth;
      render.canvas.height = document.documentElement.clientHeight;
    });
  }
});
</script>
</body>
</html>
